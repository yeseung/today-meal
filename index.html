<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì˜¤ëŠ˜ì˜ ê¸‰ì‹ - ë ˆíŠ¸ë¡œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      @font-face {
        font-family: "DOSMyungjo";
        src: url("https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_eight@1.0/DOSMyungjo.woff")
          format("woff");
        font-weight: normal;
        font-style: normal;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 20px;
        background: #c0c0c0;
        font-family: "DOSMyungjo", monospace;
        color: #000;

        /* âœ” ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬ */
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        width: 90%;
        max-width: 480px;
        background: #e5e5e5;
        padding: 0;
        border: 3px solid #000;
        box-shadow: 4px 4px 0 #000;
      }

      /* --- íƒ€ì´í‹€ë°” --- */
      h2 {
        margin: 0;
        padding: 10px;
        text-align: left;
        background: #000080;
        color: #fff;
        font-size: 18px;
        border-bottom: 3px solid #000;
      }

      /* --- ë‚´ë¶€íŒ¨ë„ --- */
      .inner {
        padding: 20px;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        font-family: "DOSMyungjo";
        border: 2px solid #000;
        margin-bottom: 12px;
        background: #fff;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #000;
        background: #ffffcc;
      }

      /* --- ë ˆíŠ¸ë¡œ ë²„íŠ¼ --- */
      button {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        font-family: "DOSMyungjo";
        cursor: pointer;
        color: #000;
        background: #d9d9d9;
        border: 3px solid #000;
        box-shadow: 3px 3px 0 #000;
      }

      button:active {
        box-shadow: 1px 1px 0 #000;
        transform: translate(2px, 2px);
        background: #bfbfbf;
      }

      /* --- ê²°ê³¼ì°½ --- */
      .result {
        margin-top: 15px;
        white-space: pre-line;
        padding: 12px;
        font-size: 15px;
        border: 2px solid #000;
        background: #fff;
        min-height: 80px;
      }

      .result::before {
        content: "â–¶ ê¸‰ì‹ ë°ì´í„°";
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
        color: #000080;
      }

      @media (max-width: 480px) {
        .inner {
          padding: 16px;
        }
        input,
        select,
        button {
          font-size: 14px;
          padding: 9px;
        }
        .result {
          font-size: 14px;
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ì˜¤ëŠ˜ì˜ ê¸‰ì‹</h2>
      <div class="inner">
        <input type="text" id="schoolName" placeholder="í•™êµ ì´ë¦„ ì…ë ¥" />
        <select id="schoolSelect" style="display: none"></select>
        <button id="searchBtn">ê¸‰ì‹ ì¡°íšŒ</button>
        <div class="result" id="lunchResult">
          ì ì‹¬ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <script>
      const input = document.getElementById("schoolName");
      const btn = document.getElementById("searchBtn");
      const select = document.getElementById("schoolSelect");
      const resultDiv = document.getElementById("lunchResult");

      document.addEventListener("DOMContentLoaded", () => {
        const savedSchool = localStorage.getItem("lastSchool");
        const savedCode = localStorage.getItem("schoolCode");
        const savedEdu = localStorage.getItem("eduCode");

        if (savedSchool && savedCode && savedEdu) {
          input.value = savedSchool;
          getLunch(savedSchool, savedCode, savedEdu);
        }
      });

      btn.addEventListener("click", async () => {
        const schoolName = input.value.trim();
        if (!schoolName) return alert("í•™êµ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");

        localStorage.setItem("lastSchool", schoolName);
        resultDiv.innerText = "í•™êµ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        const key = "6962a7e03e2b4f3e8ece1a58aacde301";
        const schUrl = `https://open.neis.go.kr/hub/schoolInfo?KEY=${key}&Type=json&SCHUL_NM=${encodeURIComponent(
          schoolName
        )}`;
        const schRes = await fetch(schUrl);
        const schData = await schRes.json();

        if (!schData.schoolInfo) {
          resultDiv.innerText = "í•™êµë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        const schoolList = schData.schoolInfo[1].row;

        if (schoolList.length === 1) {
          const s = schoolList[0];
          localStorage.setItem("schoolCode", s.SD_SCHUL_CODE);
          localStorage.setItem("eduCode", s.ATPT_OFCDC_SC_CODE);
          getLunch(s.SCHUL_NM, s.SD_SCHUL_CODE, s.ATPT_OFCDC_SC_CODE);
        } else {
          select.style.display = "block";
          select.innerHTML = "<option value=''>í•™êµ ì„ íƒ</option>";
          schoolList.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = `${s.SD_SCHUL_CODE}|${s.ATPT_OFCDC_SC_CODE}|${s.SCHUL_NM}`;
            opt.textContent = `${s.SCHUL_NM} (${s.LCTN_SC_NM}, ${s.ORG_RDNMA})`;
            select.appendChild(opt);
          });

          select.onchange = () => {
            const val = select.value;
            if (!val) return;
            const [schoolCode, eduCode, schoolName] = val.split("|");
            localStorage.setItem("schoolCode", schoolCode);
            localStorage.setItem("eduCode", eduCode);
            localStorage.setItem("lastSchool", schoolName);
            getLunch(schoolName, schoolCode, eduCode);
          };
          resultDiv.innerText = "í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
      });

      async function getLunch(schoolName, schoolCode, eduOfficeCode) {
        resultDiv.innerText = "ê¸‰ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        const today = new Date();
        const tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1);
        const ymdToday = today.toISOString().slice(0, 10).replace(/-/g, "");
        const ymdTomorrow = tomorrow
          .toISOString()
          .slice(0, 10)
          .replace(/-/g, "");
        const key = "6962a7e03e2b4f3e8ece1a58aacde301";

        try {
          const mealUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${key}&Type=json&ATPT_OFCDC_SC_CODE=${eduOfficeCode}&SD_SCHUL_CODE=${schoolCode}&MLSV_FROM_YMD=${ymdToday}&MLSV_TO_YMD=${ymdTomorrow}`;
          const mealRes = await fetch(mealUrl);
          const mealData = await mealRes.json();

          console.dir(mealData);

          const meals = mealData?.mealServiceDietInfo?.[1]?.row || [];
          const todayLunch = meals.find(
            (m) => m.MMEAL_SC_CODE == "2" && m.MLSV_YMD == ymdToday
          );
          const tomorrowLunch = meals.find(
            (m) => m.MMEAL_SC_CODE == "2" && m.MLSV_YMD == ymdTomorrow
          );

          // âœ” ì¹¼ë¡œë¦¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const calToday = todayLunch?.CAL_INFO || "ì •ë³´ ì—†ìŒ";
          const calTomorrow = tomorrowLunch?.CAL_INFO || "ì •ë³´ ì—†ìŒ";

          const format = (m) =>
            m?.DDISH_NM.replace(/<br\/>/g, ", ").replace(/\([^)]*\)/g, "") ||
            "ì •ë³´ ì—†ìŒ";

          resultDiv.innerText =
            `ğŸ± ${schoolName}\n\n` +
            `ğŸ“… ì˜¤ëŠ˜ ì ì‹¬:\n${format(todayLunch)}\nì¹¼ë¡œë¦¬: ${calToday}\n\n` +
            `ğŸ“… ë‚´ì¼ ì ì‹¬:\n${format(tomorrowLunch)}\nì¹¼ë¡œë¦¬: ${calTomorrow}`;
        } catch (e) {
          resultDiv.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          console.error(e);
        }
      }
    </script>
  </body>
</html>
